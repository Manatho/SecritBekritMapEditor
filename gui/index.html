<!DOCTYPE HTML>
<html lang="en">

<head>
    <link rel="stylesheet" href="style/index.css">
    <title>MapEditor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>

<body oncontextmenu="return false;" style="margin: 0; padding: 0">

    <script src="libs/threemin.js"></script>
    <script src="libs/MouseLock.js"></script>
    <script src="libs/mousetrap.min.js"></script>

    <script src="scripts/camera.js"></script>
    <script src="scripts/input.js"></script>
    <script src="scripts/tools.js"></script>
    <script src="scripts/terrain.js"></script>
    <script src="scripts/main.js"></script>
    <script src="scripts/tool-effect-visualiser.js"></script>

    <script src="scripts/webworker.js"></script>

    <script src="scripts/gaussianblur.js"></script>

    <!-- GUI ELEMENTS -->
    <script src="module/progressbar/Progressbar.js"></script>

    <div class="toolbar">
        <img id="png" width="70" height="70" style="image-rendering: pixelated">
        <label class="toolbar-button-conatiner">
            <input type="radio" name="toolbutton" value="deincrease" checked="checked" key="1" />
            <div class="toolbar-button">
                <img draggable="false" class="toolbar-icon" src="style/icons/in-decrease.png">
            </div>
        </label>
        <hr class="spacer">
        <label class="toolbar-button-conatiner">
            <input type="radio" name="toolbutton" value="average" key="2" />
            <div class="toolbar-button">
                <img draggable="false" class="toolbar-icon" src="style/icons/average.png">
            </div>
        </label>
        <hr class="spacer">
        <div class="toolbar-number-container">
            <label for="strength">Strength:</label>
            <input type="number" id="strength" step="1" value="5" min="0" />
        </div>
        <hr class="spacer">
        <div class="toolbar-number-container">
            <label for="size">Size:</label>
            <input type="number" id="size" step="1" value="1" min="1" />
        </div>
        <hr>
        <div class="toolbar-button" id="export">
            <img draggable="false" class="toolbar-icon" src="style/icons/export.png">
        </div>
        <a download="heightmap.png" id="downloadlink" style="display: none"></a>
    </div>


    <script>
        {
            //Tool buttons:
            let toolbuttons = document.getElementsByName('toolbutton')
            toolbuttons.forEach(button => {
                Mousetrap.bind(button.getAttribute("key"), changeTool)
                button.addEventListener("change", changeTool);

                function changeTool() {
                    button.checked = true;
                    Tools.tool = Tools.availableTools[button.value]
                    sizeInput.value = Tools.tool.size;
                }
            })


            //Stength
            let strengthInput = document.getElementById("strength");
            let numberfocusStrength = false;
            let mousedownStrength = false;
            let mousedownEventStrength;
            strengthInput.addEventListener("keydown", (event) => {
                if (event.key == "Enter" || event.key == "Escape") {
                    strengthInput.blur();
                }
            })
            strengthInput.addEventListener("blur", (event) => {
                numberfocusStrength = false;
                strengthInput.value = Math.max(strengthInput.value, 0)
                Tools.tool.strength = strengthInput.value;

            });

            strengthInput.addEventListener("focus", (event) => {
                numberfocusStrength = true;
            });

            strengthInput.addEventListener("mousedown", (event) => {
                mousedownStrength = true;
                strengthInput.setPointerCapture(1);
                mousedownEventStrength = event;
                mousedownEventStrength.strength = strengthInput.value;

            });

            strengthInput.addEventListener("mouseup", (event) => {
                mousedownStrength = false;
            });

            strengthInput.addEventListener("mousemove", (event) => {
                if (mousedownStrength) {
                    let difference = ((mousedownEventStrength.y - event.y) / 10) >> 0;
                    strengthInput.value = Number.parseInt(mousedownEventStrength.strength) + Number.parseInt(difference);
                }
            });

            document.addEventListener("mousedown", () => {
                if (numberfocusStrength) {
                    strengthInput.blur();
                }
            })

            //Size
            let sizeInput = document.getElementById("size");
            let numberfocusSize = false;
            let mousedownSize = false;
            let mousedownEventSize;
            sizeInput.addEventListener("keydown", (event) => {
                if (event.key == "Enter" || event.key == "Escape") {
                    sizeInput.blur();
                }
            })
            sizeInput.addEventListener("blur", (event) => {
                numberfocusSize = false;
                sizeInput.value = Math.max(sizeInput.value, 1)
                Tools.tool.size = sizeInput.value;

            });

            sizeInput.addEventListener("focus", (event) => {
                numberfocusSize = true;
            });

            sizeInput.addEventListener("mousedown", (event) => {
                mousedownSize = true;
                sizeInput.setPointerCapture(1);
                mousedownEventSize = event;
                mousedownEventSize.strength = sizeInput.value;

            });

            sizeInput.addEventListener("mouseup", (event) => {
                mousedownSize = false;
                if (sizeInput.value != mousedownEventSize.strength) {
                    sizeInput.blur();
                }
            });

            sizeInput.addEventListener("mousemove", (event) => {
                if (mousedownSize) {
                    let difference = ((mousedownEventSize.y - event.y) / 10) >> 0;
                    sizeInput.value = Number.parseInt(mousedownEventSize.strength) + Number.parseInt(difference);
                }
            });

            document.addEventListener("mousedown", () => {
                if (numberfocusSize) {
                    sizeInput.blur();
                }
            })

            //Export button
            let exportButton = document.getElementById("export");

            var multiplier = 1
            var sigma = 1.5;
            var max = 390;
            var min = -1110;

            exportButton.addEventListener("click", (event) => {
                console.log(event);

                Progressbar.start();
                Progressbar.visible = false;
                Progressbar.message = "Getting data";

                setTimeout(function () {
                    let heightmap = terrain.getHeightValues();

                    heightmap = mapMultiplier(heightmap, terrain.mapSize, multiplier);

                    //  var myworker = new Worker('./scripts/webworker.js');
                    var myworker = new Worker(URL.createObjectURL(new Blob(["(" + worker_function.toString() + ")()"], { type: 'text/javascript' })));
                    Progressbar.message = "Setting up data"
                    myworker.postMessage([heightmap, terrain.mapSize * multiplier]);

                    myworker.onmessage = function (e) {
                        //console.log(e);

                        switch (e.data[0]) {
                            case "Start":
                                Progressbar.visible = true;
                                Progressbar.message = e.data[1]
                                break;
                            case "Progress":
                                Progressbar.message = e.data[1] + ": " + e.data[2] + "%";
                                Progressbar.progress = e.data[2];
                                break;
                            case "Finished":
                                Progressbar.message = e.data[1];
                                Progressbar.progress = 100;
                                break;
                            case "Data":
                                document.getElementById('png').src = makepngfile(e.data[1]);
                                Progressbar.stop();
                                break;
                        }
                    }

                }, 5);

            })

            var pngfile = null;
            let makepngfile = function (image) {
                var data = new Blob([image], { type: 'image/png' });

                if (pngfile !== null) {
                    window.URL.revokeObjectURL(pngfile);
                }
                pngfile = window.URL.createObjectURL(data);
                return pngfile;
            };

            const lerp = (num, in_min, in_max, out_min, out_max) => {
                lerped = (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
                if (lerped < out_min || lerped > out_max) {
                    return Math.max(Math.min(lerped, out_max), out_min)
                }
                return lerped;
            }

            function mapMultiplier(heightmap, terrainwidth, multiplier) {
                let linesize = (terrainwidth) * multiplier + multiplier
                let multipliedMap = new Array(linesize * linesize);
                let imagesize = linesize - multiplier + 1
                terrainwidth++;

                let index = 0;
                heightmap.forEach((h, i) => {
                    let value = h;
                    if (i % terrainwidth == 0 && i != 0) {
                        index += linesize * (multiplier - 1)
                    }

                    for (let x = 0; x < multiplier; x++) {
                        for (let y = 0; y < multiplier; y++) {
                            if ((i + 1) % terrainwidth != 0 || x == 0) {
                                multipliedMap[(index + x) + (linesize * y)] = lerp(value, max, min, 0, 65535);;
                            } else {
                                multipliedMap[(index + x) + (linesize * y)] = null;
                            }
                        }
                    }
                    index += multiplier;
                });

                multipliedMap = multipliedMap.filter((h, i) => h != null);
                multipliedMap = multipliedMap.slice(0, multipliedMap.length - imagesize * (multiplier - 1))

                if (sigma > 0 && multiplier > 1) {
                    gaussBlur_4(multipliedMap, new Array(multipliedMap.length), imagesize, imagesize, sigma)
                }
                return multipliedMap;
            }
        }
    </script>




</body>

</html>